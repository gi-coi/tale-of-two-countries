<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src='JS/d3.v4.min.js'></script>
<!--     <script src="//cdnjs.cloudflare.com/ajax/libs/d3/4.7.1/d3.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3-queue/3.0.4/d3-queue.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/2.2.0/topojson.min.js"></script> -->
<!--     <script src="https://d3js.org/d3-color.v1.min.js"></script> -->
<!--     <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
-->

    <script src ='node_modules/topojson/dist/topojson.js'></script>
    <script src='node_modules/d3-color/dist/d3-color.js'></script>
    <script src='node_modules/d3-interpolate/dist/d3-interpolate.js'></script>
    <script src='node_modules/d3-queue/build/d3-queue.js'></script>
    <script src='node_modules/d3-scale-chromatic/dist/d3-scale-chromatic.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.js'></script>

    <title>IT Map possibly?</title>
    <style>
           html, body {
          width: 100%;
          padding: 0px;
          margin: 0px;
      }
            .mapVis {
                overflow: scroll; 
                margin: 0 auto;
                padding: 0px;
                height: 80vh;
                width: 65%;
                background-color: white;
                position: relative;
                font-family: 'Open Sans', sans-serif;
            }


            .area {
                stroke: #3d3c3c;
                stroke-width: .1px;
            }


            .mapVis .active {
    opacity: .5;
    stroke-width: .3px;
}
  

            div.tooltip {   
    position: absolute;           
    text-align: center;           
    min-width: 80px;                  
    min-height: 40px;                 
    padding: 2px;             
    font: 14px sans-serif;        
    background: white;   
    border: 0px;      
    border-radius: 8px;           
    pointer-events: none;         
  }

    </style>
</head>
<body>

    <div id='csection_container'>
        
        <div id='csectionGlobal' class = 'mapVis'>

        </div>
    </div>
<script>
    var width, height, svg, g, projection, path, boundaries;



var csections_data;

var format = d3.format("(.2f")
 



    var tooltip = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

    var tooltipText = tooltip
    .append('p')
    .attr('class', 'tooltipText');
/* 
        var colours = d3.scaleThreshold()
        .range(d3.schemeYlOrRd[9])
       
 */


 var colours = d3.scaleSequential(d3.interpolateYlOrRd);

 var map = d3.map();

  var init = function () {
            width = d3.select('#csectionGlobal').node().getBoundingClientRect().width;

 height = d3.select('#csectionGlobal').node().getBoundingClientRect().height;


            svg = d3.select('#csectionGlobal')
            .append('svg')
            .attr('width', width)
            .attr('height', height);


            g = svg.append('g');


           // projection = d3.geoMercator()
           // .rotate([0, 0]);

            projection = d3.geoMercator()
            .rotate([0,0]);
           

            path = d3.geoPath()
          .projection(projection);


          function reset(d) {
            active.classed('active', false)
          
        /*     active.style("stroke", "#000"); */
            active = d3.select(null)

     
            svg.transition()
                .duration(1300)
                .call(zoom.transform, d3.zoomIdentity);
        }

        function zoomFunc() {
            g.attr('transform', d3.event.transform);
        }

 


            d3.queue()
            // map credits: https://github.com/deldersveld/topojson
            .defer(d3.json, 'src/world-countries-sans-antarctica.json')
            .defer(d3.csv, 'src/c_section_global.csv')
            .await(function (error, boundary_data, c_data) {
            
                c_data.forEach(function (d) {
                  d.c_sections = +d.c_sections;                  
                })


                csections_data = c_data;

        
                console.log(csections_data);
                boundaries = boundary_data;
                console.log(boundaries);



            draw(boundary_data);
            })
        }();



        const draw = function(boundaries) {

            projection.scale(1)
            .translate([0, 0]);



            min = d3.min(csections_data, d => {
                return d.c_sections;
            })


            max = d3.max(csections_data, d => {
                return d.c_sections;
            })


/* var thresholds = []
var pace = max / 9;
var th = 0;
for (i = 0; i < 9; i ++) {
    th = th + pace;
    thresholds.push(format(th))
}

console.log(thresholds)
          colours.domain(thresholds) */


          colours.domain([min, max])

            

            console.log(colours.domain())


            csections_data.forEach( d => {
                map.set(d.country_code, d.c_sections);
            })


            var b = path.bounds(topojson.feature(boundaries, boundaries.objects['countries1']));

            var s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height);
            var t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];
            projection
                .scale(s)
                .translate(t);

                var areas = g.selectAll(".area")
                .data(topojson.feature(boundaries, boundaries.objects['countries1']).features)

               
                areas.exit().remove();
            areas
                .enter()
                .append("path")
                .attr("class", "area")
                .merge(areas)
                .attr('id', d => {
                   
                    //console.log(d);
                    return 'area' + d.id;
                })
                .attr("fill", function (d) {
                  
                   // console.log(d);
                    if (map.get(d.id) == undefined) {
                
                        // if there is no data for an area, set the no. of victims to 0 and return gray shade
                        d.properties.csections = 'Not available';
                        return '#e3e3e3'
                    }
                    else {
                      
                        // retrieve victims based on the key-value pairs created previously
                        d.properties.csections = map.get(d.id) + '%'
                        return colours( map.get(d.id))
                    }
                    /* console.log(mp.get(d.properties.PC_NAME))
                      return colours(d.properties.victims = mp.get(d.properties.PC_NAME)) ? colours(d.properties.victims = mp.get(d.properties.PC_NAME) ) : 'gray';  */
                })
                .attr('d', path)
             .on('mouseenter', function (d) {
                   
                   tooltip.transition()        
           .duration(100)      
           .style("opacity", .9) 
           .style("left", (d3.event.pageX) + "px")     
           .style("top", (d3.event.pageY - 28) + "px");

           tooltipText.html(d.properties.name + '<br>' + d.properties.csections);
       })                  
   
             
               .on("mouseout", function(d) {       
       tooltip.transition()        
           .duration(500)      
           .style("opacity", 0);   
   }) 
              
               // .on("click", clicked);





svg.append("g")
  .attr("class", "legendLinear")
  .attr("transform", "translate(30,20)");

var legendLinear = d3.legendColor()
  .shapeWidth(40)
  .cells(5)
  .orient('horizontal')
  .scale(colours);

svg.select(".legendLinear")
  .call(legendLinear);
          
        
        }

      

</script>
    </body>
    </html>